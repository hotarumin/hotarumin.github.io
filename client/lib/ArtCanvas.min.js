/**
 * ArtCanvas.js
 * @fileoverview HTML5 Canvas Library
 *
 * Copyright 2012, 2013, 2014@Tomohiro IKEDA
 * Released under the MIT license
 */
(function(n){function b(a,e,d,c,f){this.container=document.body;a instanceof HTMLElement&&(this.container=a);this.container.style.position="relative";this.container.style.top="0px";this.container.style.left="0px";this.container.style.zIndex=1;a=parseInt(d);var g=parseInt(c);this.container.style.width=0<a?a+"px":b.DEFAULT_SIZES.WIDTH+"px";this.container.style.height=0<g?g+"px":b.DEFAULT_SIZES.HEIGHT+"px";this.mode=b.Mode.HAND;this.figure=b.Figure.RECTANGLE;this.textStyle=new b.TextStyle(new b.Font("Arial",
"normal","16px"),(new b.Color(0,0,0,1)).toString());this.transform=b.Transform.TRANSLATE;this.layers=[];this.layers.push(new b.Canvas(this.container,e,d,c,this.layers.length+2));this.activeLayer=0;this.callbacks={drawstart:function(){},drawmove:function(){},drawend:function(){},changemode:function(){},selectlayer:function(){},showlayer:function(){},hidelayer:function(){},addlayer:function(){},removelayer:function(){}};this.setCallbacks(f);var k=null,h=!1,l=this,m=function(e,a,c,d,f){if(/mousedown|touchstart/i.test(f))e=
e.getCanvas(),k=a.getImageData(0,0,e.width,e.height);else{var g=e.popPath(),h=g.pop();g.push(h);e.pushPath(g);a.putImageData(k,0,0);switch(l.figure){case b.Figure.RECTANGLE:var g=h.getX(),m=h.getY();c=b.Point.getOffsetPoint(h,new b.Point(c,d));a.beginPath();a.rect(g,m,c.getX(),c.getY());a.stroke();a.fill();/mouseup|touchend/i.test(f)&&(e.popPath(),e.pushPath(new b.Rectangle(g,m,c.getX(),c.getY())));break;case b.Figure.CIRCLE:g=h.getX();m=h.getY();c=b.Point.getDistance(h,new b.Point(c,d));a.beginPath();
a.arc(g,m,c,0,2*Math.PI,!1);a.stroke();a.fill();/mouseup|touchend/i.test(f)&&(e.popPath(),e.pushPath(new b.Circle(g,m,c,0,2*Math.PI,!1)));break;case b.Figure.LINE:a.beginPath(),a.moveTo(h.getX(),h.getY()),a.lineTo(c,d),a.stroke(),/mouseup|touchend/i.test(f)&&(e.popPath(),e.pushPath(new b.Line(h,new b.Point(c,d))))}}};this.container.addEventListener(b.MouseEvents.START,function(e){if(l.mode!==b.Mode.TOOL){var a=l.layers[l.activeLayer],c=a.getContext();c.globalCompositeOperation=l.mode===b.Mode.ERASER?
"destination-out":"source-over";var d=a.getOffsetX(e),f=a.getOffsetY(e);switch(l.mode){case b.Mode.HAND:case b.Mode.ERASER:c.beginPath();c.moveTo(d,f);break;case b.Mode.FIGURE:m(a,c,d,f,e.type);break;case b.Mode.TEXT:a.createTextbox(new b.Point(d,f));return}a.pushPath([new b.Point(d,f)]);h=!0;l.callbacks.drawstart(a,c,d,f)}},!0);this.container.addEventListener(b.MouseEvents.MOVE,function(a){if(h){a.preventDefault();var e=l.layers[l.activeLayer],c=e.getContext(),d=e.getOffsetX(a),f=e.getOffsetY(a);
switch(l.mode){case b.Mode.HAND:case b.Mode.ERASER:a=e.popPath();var g=a.pop();c.beginPath();c.moveTo(g.getX(),g.getY());c.lineTo(d,f);c.stroke();a.push(g);switch(l.mode){case b.Mode.HAND:a.push(new b.Point(d,f));break;case b.Mode.ERASER:a.push(new b.Eraser(new b.Point(d,f)))}e.pushPath(a);break;case b.Mode.FIGURE:m(e,c,d,f,a.type);break;case b.Mode.TRANSFORM:a=e.popPath();var g=a.pop(),k=b.Point.getOffsetPoint(g,new b.Point(d,f)),t=[];switch(l.transform){case b.Transform.TRANSLATE:t.push(k.getX());
t.push(k.getY());break;case b.Transform.SCALE:var u=e.getCanvas(),v=1,w=1,n=k.getX(),k=k.getY();0!==n&&(v+=n/u.width);0!==k&&(w+=k/u.height);t.push(v);t.push(w);break;case b.Transform.ROTATE:u=Math.atan2(k.getY(),k.getX())/Math.PI*180,t.push(u)}e.transform(l.transform,t);a.push(g);e.pushPath(a)}l.callbacks.drawmove(e,c,d,f)}},!0);n.addEventListener(b.MouseEvents.END,function(a){if(h){var e=l.layers[l.activeLayer],c=e.getContext(),d=e.getOffsetX(a),f=e.getOffsetY(a);switch(l.mode){case b.Mode.ERASER:c.globalCompositeOperation=
"source-over";break;case b.Mode.FIGURE:m(e,c,d,f,a.type);k=null;break;case b.Mode.TRANSFORM:e.popPath()}h=!1;e.increaseHistoryPointer();l.callbacks.drawend(e,c,d,f)}},!0)}b.DEFAULT_SIZES={};b.DEFAULT_SIZES.WIDTH=300;b.DEFAULT_SIZES.HEIGHT=300;b.prototype.getContainerWidth=function(){return parseInt(this.container.style.width)};b.prototype.getContainerHeight=function(){return parseInt(this.container.style.height)};b.prototype.setCallbacks=function(a){if("[object Object]"!==Object.prototype.toString.call(a))return this;
for(var e in a)e in this.callbacks&&"[object Function]"===Object.prototype.toString.call(a[e])&&(this.callbacks[e]=a[e]);return this};b.prototype.getMode=function(){return this.mode};b.prototype.setMode=function(a){a=String(a).toLowerCase();switch(a){case b.Mode.HAND:case b.Mode.FIGURE:case b.Mode.ERASER:case b.Mode.TRANSFORM:case b.Mode.TOOL:this.mode=a;break;case b.Mode.TEXT:this.mode=a,this.addLayer(this.getContainerWidth(),this.getContainerHeight())}this.layers[this.activeLayer].drawText(this.textStyle);
this.callbacks.changemode(a);return this};b.prototype.getActiveLayer=function(){return this.activeLayer};b.prototype.validateLayerNumber=function(a){a=parseInt(a);return 0<=a&&a<this.layers.length};b.prototype.selectLayer=function(a){this.validateLayerNumber(a)&&(this.activeLayer=a=parseInt(a),this.callbacks.selectlayer(a));return this};b.prototype.showLayer=function(a){if(this.validateLayerNumber(a)){a=parseInt(a);var e=this.layers[a];e.getCanvas().style.visibility="visible";this.callbacks.showlayer(e,
a)}return this};b.prototype.hideLayer=function(a){if(this.validateLayerNumber(a)){a=parseInt(a);var e=this.layers[a];e.getCanvas().style.visibility="hidden";this.callbacks.hidelayer(e,a)}return this};b.prototype.addLayer=function(a,e){this.layers.push(new b.Canvas(this.container,null,a,e,this.layers.length+2));this.activeLayer=this.layers.length-1;this.callbacks.addlayer(this.layers[this.activeLayer],this.activeLayer);return this};b.prototype.removeLayer=function(a){if(1<this.layers.length&&this.validateLayerNumber(a)){a=
parseInt(a);var e=this.layers[a],b=e.getCanvas();this.layers.splice(a,1);b.parentNode.removeChild(b);0<this.activeLayer&&a<=this.activeLayer&&this.activeLayer--;this.callbacks.removelayer(e,a)}return this};b.prototype.undo=function(){return this.layers[this.activeLayer].undo()};b.prototype.redo=function(){return this.layers[this.activeLayer].redo()};b.prototype.clear=function(){this.layers[this.activeLayer].clear();return this};b.prototype.getFillStyle=function(){return this.layers[this.activeLayer].getFillStyle()};
b.prototype.setFillStyle=function(a){this.layers[this.activeLayer].setFillStyle(a);return this};b.prototype.getStrokeStyle=function(){return this.layers[this.activeLayer].getStrokeStyle()};b.prototype.setStrokeStyle=function(a){this.layers[this.activeLayer].setStrokeStyle(a);return this};b.prototype.getLineWidth=function(){return this.layers[this.activeLayer].getLineWidth()};b.prototype.setLineWidth=function(a){this.layers[this.activeLayer].setLineWidth(a);return this};b.prototype.getLineCap=function(){return this.layers[this.activeLayer].getLineCap()};
b.prototype.setLineCap=function(a){this.layers[this.activeLayer].setLineCap(a);return this};b.prototype.getLineJoin=function(){return this.layers[this.activeLayer].getLineJoin()};b.prototype.setLineJoin=function(a){this.layers[this.activeLayer].setLineJoin(a);return this};b.prototype.getShadowColor=function(){return this.layers[this.activeLayer].getShadowColor()};b.prototype.setShadowColor=function(a){this.layers[this.activeLayer].setShadowColor(a);return this};b.prototype.getShadowBlur=function(){return this.layers[this.activeLayer].getShadowBlur()};
b.prototype.setShadowBlur=function(a){this.layers[this.activeLayer].setShadowBlur(a);return this};b.prototype.getShadowOffsetX=function(){return this.layers[this.activeLayer].getShadowOffsetX()};b.prototype.setShadowOffsetX=function(a){this.layers[this.activeLayer].setShadowOffsetX(a);return this};b.prototype.getShadowOffsetY=function(){return this.layers[this.activeLayer].getShadowOffsetY()};b.prototype.setShadowOffsetY=function(a){this.layers[this.activeLayer].setShadowOffsetY(a);return this};b.prototype.getGlobalAlpha=
function(){return this.layers[this.activeLayer].getGlobalAlpha()};b.prototype.setGlobalAlpha=function(a){this.layers[this.activeLayer].setGlobalAlpha(a);return this};b.prototype.getTextStyle=function(){return this.textStyle};b.prototype.setTextStyle=function(a){a instanceof b.TextStyle&&(this.textStyle=a);return this};b.prototype.getFigure=function(){return this.figure};b.prototype.setFigure=function(a){a=String(a).toLowerCase();switch(a){case b.Figure.RECTANGLE:case b.Figure.CIRCLE:case b.Figure.LINE:this.figure=
a}return this};b.prototype.getTransform=function(){return this.transform};b.prototype.setTransform=function(a){a=String(a).toLowerCase();switch(a){case b.Transform.TRANSLATE:case b.Transform.SCALE:case b.Transform.ROTATE:this.transform=a}return this};b.prototype.translate=function(a,e){this.layers[this.activeLayer].transform(b.Transform.TRANSLATE,[a,e]);return this};b.prototype.scale=function(a,e){this.layers[this.activeLayer].transform(b.Transform.SCALE,[a,e]);return this};b.prototype.rotate=function(a){this.layers[this.activeLayer].transform(b.Transform.ROTATE,
[a]);return this};b.prototype.drawImage=function(a){this.layers[this.activeLayer].drawImage(a);return this};b.prototype.pickColor=function(a){return this.layers[this.activeLayer].pickColor(a)};b.prototype.fill=function(a,e){this.layers[this.activeLayer].fill(a,e);return this};b.prototype.filter=function(a,e){this.layers[this.activeLayer].filter(a,e);return this};b.prototype["export"]=function(a,e){if(!/gif|jpeg|jpg|png/i.test(String(a)))return this;var b=document.createElement("canvas"),c=b.getContext("2d");
b.width=this.getContainerWidth();b.height=this.getContainerHeight();var f=[],g=0,k=this,h=function(){for(var g=0,h=f.length;g<h;g++)c.drawImage(f[g],0,0);"[object Function]"===Object.prototype.toString.call(e)&&e(b.toDataURL("image/"+a.toLowerCase()))},l=function(){if(g>=k.layers.length)h();else{var a=k.layers[g].getCanvas();if("hidden"===a.style.visibility)g++,l();else{var a=a.toDataURL("image/png"),e=new Image;e.src=a;e.onload=function(){f.push(e);g++;l()}}}};l();return this};(function(){function a(){}
a.prototype.draw=function(a){};a.prototype.getCenterPoint=function(a){};b.Drawable=a})();(function(){function a(){}var e="",d="",c="",f="";/iPhone|iPad|iPod|Android/.test(navigator.userAgent)?(e="touchend",d="touchstart",c="touchmove",f="touchend"):(e="click",d="mousedown",c="mousemove",f="mouseup");a.CLICK=e;a.START=d;a.MOVE=c;a.END=f;b.MouseEvents=a})();(function(){function a(){}a.HAND="hand";a.FIGURE="figure";a.TEXT="text";a.ERASER="eraser";a.TOOL="tool";a.TRANSFORM="transform";b.Mode=a})();(function(){function a(){}
a.RECTANGLE="rectangle";a.CIRCLE="circle";a.LINE="line";b.Figure=a})();(function(){function a(){}a.TRANSLATE="translate";a.SCALE="scale";a.ROTATE="rotate";b.Transform=a})();(function(){function a(){}a.DROPPER="dropper";a.BUCKET="bucket";b.Tool=a})();(function(){function a(a,b,c,f){this.blue=this.green=this.red=0;this.alpha=1;a=parseInt(a);b=parseInt(b);c=parseInt(c);f=parseInt(f);!isNaN(a)&&0<=a&&255>=a&&(this.red=a);!isNaN(b)&&0<=b&&255>=b&&(this.green=b);!isNaN(c)&&0<=c&&255>=c&&(this.blue=c);!isNaN(f)&&
0<=f&&1>=f&&(this.alpha=f)}a.prototype.getRed=function(){return this.red};a.prototype.getGreen=function(){return this.green};a.prototype.getBlue=function(){return this.blue};a.prototype.getAlpha=function(){return this.alpha};a.prototype.toString=function(){return"rgba("+this.red+", "+this.green+", "+this.blue+", "+this.alpha+")"};a.prototype.toHexString=function(){var a;return a="#"+(this.red.toString(16)+this.green.toString(16)+this.blue.toString(16))};b.Color=a})();(function(){function a(a,b){this.y=
this.x=0;var c=parseFloat(a),f=parseFloat(b);isNaN(c)||(this.x=c);isNaN(f)||(this.y=f)}a.prototype.getX=function(){return this.x};a.prototype.getY=function(){return this.y};a.getOffsetPoint=function(e,b){var c=0,f=0;e instanceof a&&b instanceof a&&(c=b.getX()-e.getX(),f=b.getY()-e.getY());return new a(c,f)};a.getDistance=function(e,b){var c=a.getOffsetPoint(e,b);return Math.sqrt(Math.pow(c.getX(),2)+Math.pow(c.getY(),2))};b.Point=a})();(function(){function a(a,d,c,f){b.Drawable.call(this);this.height=
this.width=this.left=this.top=0;a=parseFloat(a);d=parseFloat(d);c=parseFloat(c);f=parseFloat(f);isNaN(a)||(this.top=a);isNaN(d)||(this.left=d);0<=c&&(this.width=c);0<=f&&(this.height=f)}a.prototype=Object.create(b.Drawable.prototype);a.prototype.constructor=a;a.prototype.getTop=function(){return this.top};a.prototype.getLeft=function(){return this.left};a.prototype.getBottom=function(){return this.top+this.height};a.prototype.getRight=function(){return this.left+this.width};a.prototype.getLeftTop=
function(){return{top:this.top,left:this.left}};a.prototype.getRightBottom=function(){return{bottom:this.top+this.height,right:this.left+this.width}};a.prototype.getWidth=function(){return this.width};a.prototype.getHeight=function(){return this.height};a.prototype.getSize=function(){return{width:this.width,height:this.height}};a.prototype.draw=function(a){a.beginPath();a.rect(this.top,this.left,this.width,this.height);a.stroke();a.fill()};a.prototype.getCenterPoint=function(a){a=parseInt(this.width/
2)+this.left;var d=parseInt(this.height/2)+this.top;return new b.Point(a,d)};b.Rectangle=a})();(function(){function a(a,d,c){b.Drawable.call(this);this.radius=this.centerY=this.centerX=0;a=parseFloat(a);d=parseFloat(d);c=parseFloat(c);isNaN(a)||(this.centerX=a);isNaN(d)||(this.centerY=d);0<=c&&(this.radius=c)}a.prototype=Object.create(b.Drawable.prototype);a.prototype.constructor=a;a.prototype.getCenterX=function(){return this.centerX};a.prototype.getCenterY=function(){return this.centerY};a.prototype.getCenter=
function(){return{x:this.centerX,y:this.centerY}};a.prototype.getRadius=function(){return this.radius};a.prototype.draw=function(a){a.beginPath();a.arc(this.centerX,this.centerY,this.radius,0,2*Math.PI,!1);a.stroke();a.fill()};a.prototype.getCenterPoint=function(a){return new b.Point(this.centerX,this.centerY)};b.Circle=a})();(function(){function a(a,d){b.Drawable.call(this);this.endPoint=this.startPoint=null;a instanceof b.Point&&(this.startPoint=a);d instanceof b.Point&&(this.endPoint=d)}a.prototype=
Object.create(b.Drawable.prototype);a.prototype.constructor=a;a.prototype.getStartPoint=function(){return this.startPoint};a.prototype.getEndPoint=function(){return this.endPoint};a.prototype.draw=function(a){a.beginPath();a.moveTo(this.startPoint.getX(),this.startPoint.getY());a.lineTo(this.endPoint.getX(),this.endPoint.getY());a.stroke()};a.prototype.getCenterPoint=function(a){var d=Math.min(this.startPoint.x,this.endPoint.x);a=Math.min(this.startPoint.y,this.endPoint.y);var c=Math.max(this.startPoint.x,
this.endPoint.x),f=Math.max(this.startPoint.y,this.endPoint.y),d=parseInt((c-d)/2+d);a=parseInt((f-a)/2+a);return new b.Point(d,a)};b.Line=a})();(function(){function a(a,d,g){b.Drawable.call(this);this.text=String(a);this.point=new b.Point(0,0);this.textStyle=null;d instanceof b.Point&&(this.point=d);g instanceof e&&(this.textStyle=g)}function e(a,e){this.font=null;this.color=String(e);a instanceof d&&(this.font=a)}function d(a,e,b){this.family=String(a);this.style=String(e);this.size=String(b)}a.prototype=
Object.create(b.Drawable.prototype);a.prototype.constructor=a;a.prototype.getText=function(){return this.text};a.prototype.getPoint=function(){return this.point};a.prototype.getTextStyle=function(){return this.textStyle};a.prototype.draw=function(a){var e=this.textStyle.getFont(),b=this.textStyle.getColor(),d=a.fillStyle;a.font=e.getFontString();a.fillStyle=b;a.fillText(this.text,this.point.getX(),this.point.getY());a.fillStyle=d};a.prototype.getCenterPoint=function(a){var e=this.textStyle.getFont(),
e=parseInt(e.getSize());a=this.point.getX()+parseInt(a.measureText(this.text).width/2);e=this.point.getY()+parseInt(e/2);return new b.Point(a,e)};e.prototype.getFont=function(){return this.font};e.prototype.getColor=function(){return this.color};d.prototype.getFamily=function(){return this.family};d.prototype.getStyle=function(){return this.style};d.prototype.getSize=function(){return this.size};d.prototype.getFontString=function(){return this.style+" "+this.size+' "'+this.family+'"'};b.Text=a;b.TextStyle=
e;b.Font=d})();(function(){function a(a,d){b.Drawable.call(this);this.image=new Image;this.image.src=a;this.image.onload=d}a.prototype=Object.create(Image.prototype);a.prototype=Object.create(b.Drawable.prototype);a.prototype.constructor=a;a.prototype.draw=function(a){a.drawImage(this.image,0,0)};a.prototype.getCenterPoint=function(a){return new b.Point(Math.floor(this.image.width/2),Math.floor(this.image.height/2))};b.DrawableImage=a})();(function(){function a(a){this.point=null;a instanceof b.Point&&
(this.point=a)}a.prototype.getPoint=function(){return this.point};a.prototype.getX=function(){return this.point instanceof b.Point?this.point.getX():0};a.prototype.getY=function(){return this.point instanceof b.Point?this.point.getY():0};b.Eraser=a})();(function(){function a(e,b){this.type=a.NONE;String(e).toUpperCase()in a&&(this.type=String(e).toLowerCase());this.amounts=[];Array.isArray(b)&&(this.amounts=b)}a.NONE="none";a.REDEMPHASIS="redemphasis";a.GRAYSCALE="grayscale";a.REVERSE="reverse";a.NOISE=
"noise";a.BLUR="blur";a.prototype.getType=function(){return this.type};a.prototype.getAmounts=function(){return this.amounts};a.prototype.none=function(a){return a};a.prototype.redemphasis=function(a,b){for(var c=0,f=a.data.length;c<f;c++)switch(c%4){case 0:b.data[c]=Math.floor(1.5*a.data[c]);255<b.data[c]&&(b.data[c]=255);break;case 1:b.data[c]=Math.floor(0*a.data[c]);break;case 2:b.data[c]=Math.floor(1*a.data[c]);break;case 3:b.data[c]=Math.floor(1*a.data[c])}return b};a.prototype.grayscale=function(a,
b){for(var c=0,f=a.data.length;c<f;c+=4)b.data[c]=b.data[c+1]=b.data[c+2]=Math.floor((a.data[c]+a.data[c+1]+a.data[c+2])/3),b.data[c+3]=a.data[c+3];return b};a.prototype.reverse=function(a,b){for(var c=0,f=a.data.length;c<f;c+=4)b.data[c+0]=255-a.data[c+0],b.data[c+1]=255-a.data[c+1],b.data[c+2]=255-a.data[c+2],b.data[c+3]=a.data[c+3];return b};a.prototype.noise=function(a,b){if(!Array.isArray(this.amounts)||3>this.amounts.length)return a;var c=parseInt(this.amounts[0]);if(isNaN(c)||0>c)return a;
var f=parseInt(this.amounts[1]);if(isNaN(f)||0>f)return a;var g=parseInt(this.amounts[2]);if(isNaN(g)||0>g)return a;for(var k=0;k<g;k++){var h=Math.floor(Math.random()*c),h=4*(Math.floor(Math.random()*f)*c+h),l=a.data[h+1]>>2,m=a.data[h+2]>>1;b.data[h+0]=a.data[h+0]>>1;b.data[h+1]=l;b.data[h+2]=m;b.data[h+3]=a.data[h+3]}return b};a.prototype.blur=function(a,b){if(!Array.isArray(this.amounts)||1>this.amounts.length)return a;var c=Array(9),f=0,g=0,k=parseInt(this.amounts[0]);if(isNaN(k)||0>k)return a;
for(var h=0,l=a.data.length;h<l;h++){for(var c=[h-4-4*k,h-4*k,h+4-4*k,h-4,h,h+4,h-4+4*k,h+4*k,h+4+4*k],m=g=f=0;9>m;m++)0<=c[m]&&c[m]<a.data.length&&(f+=a.data[c[m]],g++);b.data[h]=Math.floor(f/g)}return b};a.prototype.filter=function(a){var b=a.context.getImageData(0,0,a.canvas.width,a.canvas.height),c=a.context.createImageData(a.canvas.width,a.canvas.height);a.context.putImageData(this[this.type](b,c),0,0);return this};b.Filter=a})();(function(){function a(a,d,c,f,g){this.container=document.body;
this.context=this.canvas=null;a instanceof HTMLElement&&(this.container=a);d instanceof HTMLCanvasElement?this.canvas=d:(this.canvas=document.createElement("canvas"),this.container.appendChild(this.canvas));this.context=this.canvas.getContext("2d");a=parseInt(c);f=parseInt(f);0<a&&(this.canvas.width=a);0<f&&(this.canvas.height=f);this.clear();this.canvas.style.position="absolute";this.canvas.style.top="0px";this.canvas.style.left="0px";this.canvas.style.zIndex=g;this.context.strokeStyle=(new b.Color(0,
0,0,1)).toString();this.context.fillStyle=(new b.Color(0,0,0,1)).toString();this.context.globalAlpha=1;this.context.lineWidth=1;this.context.lineCap="butt";this.context.lineJoin="miter";this.paths=[];this.historyPointer=0;this.transforms={translate:{x:0,y:0},scale:{x:1,y:1},skew:{x:0,y:0},rotate:0}}a.prototype.getCanvas=function(){return this.canvas};a.prototype.getContext=function(){return this.context};a.prototype.getPaths=function(){return this.paths};a.prototype.pushPath=function(a){this.paths[this.historyPointer]=
a;return this};a.prototype.popPath=function(){return this.paths[this.historyPointer]};a.prototype.getHistoryPointer=function(){return this.historyPointer};a.prototype.increaseHistoryPointer=function(){this.historyPointer++;this.historyPointer<this.paths.length&&(this.paths=this.paths.slice(0,this.historyPointer));return this};a.prototype.draw=function(a){a&&this.transform();for(a=0;a<this.historyPointer;a++){var d=this.paths[a];if(Array.isArray(d))for(var c=0,f=d.length;c<f;c++){var g=d[c],k=g.getX(),
h=g.getY();g instanceof b.Eraser&&(this.context.globalCompositeOperation="destination-out");0===c?(this.context.beginPath(),this.context.moveTo(k,h)):(this.context.lineTo(k,h),this.context.stroke());g instanceof b.Eraser&&(this.context.globalCompositeOperation="source-over")}else d instanceof b.Filter?d.filter(this):d.draw(this.context)}return this};a.prototype.drawText=function(a){if(!(a instanceof b.TextStyle))return"";var d=this.container.querySelector('[type="text"]');if(!(d instanceof HTMLInputElement))return"";
var c=a.getFont(),f=a.getColor(),g=parseInt(c.getSize()),k=d.value,h=parseInt(d.style.left),g=parseInt(d.style.top)+g;this.container.removeChild(d);d=this.context.fillStyle;this.context.font=c.getFontString();this.context.fillStyle=f;this.context.fillText(k,h,g);this.context.fillStyle=d;this.paths.push(new b.Text(k,new b.Point(h,g),a));this.increaseHistoryPointer();return k};a.prototype.drawImage=function(a){var d=this,c=new b.DrawableImage(String(a),function(){d.context.drawImage(this,0,0);d.paths.push(c);
d.historyPointer++});return this};a.prototype.transform=function(a,d){Array.isArray(d)||(d=[d]);var c=this.getCenterPoint();if(null!==c){var f=c.getX(),c=c.getY(),g=this.transforms,k=g.translate,h=g.scale;switch(String(a).toLowerCase()){case b.Transform.TRANSLATE:if(2>d.length)break;var l=parseFloat(d[0]),m=parseFloat(d[1]);if(isNaN(l)||isNaN(m))break;k.x=l;k.y=m;break;case b.Transform.SCALE:if(2>d.length)break;l=parseFloat(d[0]);m=parseFloat(d[1]);if(isNaN(l)||isNaN(m))break;h.x=l;h.y=m;break;case b.Transform.ROTATE:if(1>
d.length)break;l=parseFloat(d[0]);if(isNaN(l))break;g.rotate=l*Math.PI/180}g=g.rotate;g=[Math.cos(g),Math.sin(g),-Math.sin(g),Math.cos(g),0,0];this.clear();this.context.save();switch(String(a).toLowerCase()){case b.Transform.TRANSLATE:case b.Transform.SCALE:this.context.setTransform(1,0,0,1,0,0);this.context.transform(1,0,0,1,f,c);this.context.transform.apply(this.context,g);this.context.transform(1,0,0,1,-f,-c);this.context.transform(h.x,0,0,h.y,k.x,k.y);break;case b.Transform.ROTATE:this.context.setTransform(1,
0,0,1,0,0),this.context.transform(h.x,0,0,h.y,k.x,k.y),this.context.transform(1,0,0,1,f,c),this.context.transform.apply(this.context,g),this.context.transform(1,0,0,1,-f,-c)}1<arguments.length&&(this.draw(!1),this.context.restore());return this}};a.prototype.clear=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);return this};a.prototype.clearPaths=function(){this.paths=[];return this};a.prototype.undo=function(){return 0<this.historyPointer?(this.historyPointer--,this.clear(),
this.draw(!0),!0):!1};a.prototype.redo=function(){return this.historyPointer<this.paths.length?(this.historyPointer++,this.clear(),this.draw(!0),!0):!1};a.prototype.getFillStyle=function(){return this.context.fillStyle};a.prototype.setFillStyle=function(a){this.context.fillStyle=String(a);this.draw(!0);return this};a.prototype.getStrokeStyle=function(){return this.context.strokeStyle};a.prototype.setStrokeStyle=function(a){this.context.strokeStyle=String(a);this.draw(!0);return this};a.prototype.getLineWidth=
function(){return this.context.lineWidth};a.prototype.setLineWidth=function(a){a=parseFloat(a);0<a&&(this.context.lineWidth=a,this.draw(!0));return this};a.prototype.getLineCap=function(){return this.context.lineCap};a.prototype.setLineCap=function(a){if(!/butt|round|square/i.test(String(a)))return this;this.context.lineCap=a.toLowerCase();this.draw(!0);return this};a.prototype.getLineJoin=function(){return this.context.lineJoin};a.prototype.setLineJoin=function(a){if(!/bevel|round|miter/i.test(String(a)))return this;
this.context.lineJoin=a.toLowerCase();this.draw(!0);return this};a.prototype.getShadowColor=function(){return this.context.shadowColor};a.prototype.setShadowColor=function(a){this.context.shadowColor=String(a);this.draw(!0);return this};a.prototype.getShadowBlur=function(){return this.context.shadowBlur};a.prototype.setShadowBlur=function(a){a=parseFloat(a);0<=a&&(this.context.shadowBlur=a,this.draw(!0));return this};a.prototype.getGlobalAlpha=function(){return this.context.globalAlpha};a.prototype.setGlobalAlpha=
function(a){a=parseFloat(a);0<=a&&1>=a&&(this.context.globalAlpha=a,this.draw(!0));return this};a.prototype.getShadowOffsetX=function(){return this.context.shadowOffsetX};a.prototype.setShadowOffsetX=function(a){a=parseFloat(a);isNaN(a)||(this.context.shadowOffsetX=a,this.draw(!0));return this};a.prototype.getShadowOffsetY=function(){return this.context.shadowOffsetY};a.prototype.setShadowOffsetY=function(a){a=parseFloat(a);isNaN(a)||(this.context.shadowOffsetY=a,this.draw(!0));return this};a.prototype.getOffsetX=
function(a){if(!(a instanceof Event))return 0;a.pageX||(a.touches[0]?a=a.touches[0]:a.changedTouches[0]&&(a=a.changedTouches[0]));a=a.pageX-this.container.offsetLeft+this.container.scrollLeft;var b=this.canvas.width;0>a&&(a=0);a>b&&(a=b);return a};a.prototype.getOffsetY=function(a){if(!(a instanceof Event))return 0;a.pageY||(a.touches[0]?a=a.touches[0]:a.changedTouches[0]&&(a=a.changedTouches[0]));a=a.pageY-this.container.offsetTop+this.container.scrollTop;var b=this.canvas.height;0>a&&(a=0);a>b&&
(a=b);return a};a.prototype.getCenterPoint=function(){for(var a=null,d=0;d<this.historyPointer;d++){var c=this.paths[d];if(Array.isArray(c)){for(var f=Number.MAX_VALUE,a=Number.MAX_VALUE,g=0,k=0,h=0,l=c.length;h<l;h++){var m=c[h],q=m.getX(),m=m.getY();q<f&&(f=q);m<a&&(a=m);q>g&&(g=q);m>k&&(k=m)}c=parseInt((g-f)/2+f);a=parseInt((k-a)/2+a);a=new b.Point(c,a)}else c instanceof b.Drawable&&(a=c.getCenterPoint(this.context))}return a};a.prototype.createTextbox=function(a){if(!(a instanceof b.Point)||this.container.querySelector('[type="text"]')instanceof
HTMLInputElement)return this;var d=a.getX();a=a.getY();var c=document.createElement("input");c.setAttribute("type","text");c.style.position="absolute";c.style.top=a+"px";c.style.left=d+"px";c.style.zIndex=parseInt(this.canvas.style.zIndex)+1;c.style.outline="none";c.style.padding="0.5em";this.container.appendChild(c);return c};a.prototype.pickColor=function(a){if(!(a instanceof Event))return new b.Color(0,0,0,1);a=this.context.getImageData(this.getOffsetX(a),this.getOffsetY(a),1,1);return new b.Color(a.data[0],
a.data[1],a.data[2],a.data[3]/255)};a.prototype.fill=function(a,d){if(a instanceof Event&&d instanceof b.Color){var c=this.canvas.width,f=this.canvas.height,g=this.context.getImageData(0,0,c,f),k=this.getOffsetX(a),h=this.getOffsetY(a),l=function(a,b,d){a=4*(c*b+a);return g.data[a]!==d.getRed()?!1:g.data[a+1]!==d.getGreen()?!1:g.data[a+2]!==d.getBlue()?!1:g.data[a+3]!==d.getAlpha()?!1:!0},m=function(a,b,e){for(;a<=b;a++){var f=g,h=4*(c*e+a),k=d;f.data[h]=k.getRed();f.data[h+1]=k.getGreen();f.data[h+
2]=k.getBlue();f.data[h+3]=255*k.getAlpha()}},q=function(a,b,c,d,e){for(;a<=b;){for(;a<=b&&!l(a,c,e);)a++;if(a>b)break;for(;a<=b;)if(l(a,c,e))a++;else break;d.push({x:a-1,y:c})}},p=4*(c*h+k),p=new b.Color(g.data[p],g.data[p+1],g.data[p+2],g.data[p+3]);if(l(k,h,d))this.context.putImageData(g,0,0);else{var n=[];for(n.push({x:k,y:h});0<n.length;){var k=n.pop(),r=h=k.x;if(!l(k.x,k.y,d)){for(;0<h;)if(l(h-1,k.y,p))h--;else break;for(;r<this.canvas.width-1;)if(l(r+1,k.y,p))r++;else break;m(h,r,k.y);k.y+
1<f&&q(h,r,k.y+1,n,p);0<=k.y-1&&q(h,r,k.y-1,n,p)}}this.context.putImageData(g,0,0);return this}}};a.prototype.filter=function(a,d){var c=new b.Filter(a,d);c.filter(this);this.paths.push(c);this.increaseHistoryPointer();return this};b.Canvas=a})();n.ArtCanvas=b})(window);